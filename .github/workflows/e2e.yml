name: E2E Tests

on:
 pull_request:
  types: [opened, synchronize]

jobs:
 e2e:
  runs-on: ubuntu-latest
  permissions:
   contents: read
   pull-requests: write
   issues: write
   id-token: write
  steps:
   - uses: actions/checkout@v4

   - uses: pnpm/action-setup@v4

   - uses: actions/setup-node@v4
     with:
      node-version: 22
      cache: "pnpm"

   - run: pnpm install

   - name: Setup Playwright
     uses: ./.github/actions/setup-playwright

   - name: Run E2E tests
     id: e2e
     run: pnpm test:e2e
     continue-on-error: true

   - name: Analyze E2E failure with Claude
     if: steps.e2e.outcome == 'failure'
     uses: anthropics/claude-code-action@v1
     with:
      claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
      prompt: |
       REPO: ${{ github.repository }}
       PR NUMBER: ${{ github.event.pull_request.number }}

       ## ì—­í• 
       ë‹¹ì‹ ì€ ì‘ì—…ìê°€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ì˜ ì›ì¸ì„ ë¹ ë¥´ê²Œ íŒŒì•…í•  ìˆ˜ ìˆë„ë¡ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì •ë¦¬í•˜ëŠ” ì¡°ì‚¬ê´€ì…ë‹ˆë‹¤.

       ## ë¶„ì„ ì ˆì°¨
       1. `test-results/` í´ë”ì—ì„œ `error-context.md` íŒŒì¼ë“¤ì„ ëª¨ë‘ ì°¾ì•„ ì½ìœ¼ì„¸ìš”
       2. ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ì˜ ì†ŒìŠ¤ì½”ë“œ(`e2e/tests/*.spec.ts`)ì™€ POM(`e2e/pom/`)ì„ í™•ì¸í•˜ì„¸ìš”
       3. ê´€ë ¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ì˜ì—­ì„ íƒìƒ‰í•˜ì„¸ìš”

       ## ì›ì¹™
       - ìˆ˜ì • ì œì•ˆì´ë‚˜ ì½”ë“œ í”½ìŠ¤ë¥¼ í•˜ì§€ ë§ˆì„¸ìš”. ì»¨í…ìŠ¤íŠ¸ ì „ë‹¬ë§Œ í•˜ì„¸ìš”.
       - ì‘ì—…ìê°€ ë””ë²„ê¹…ì„ ì‹œì‘í•  ìˆ˜ ìˆëŠ” ì§„ì…ì (íŒŒì¼, í•¨ìˆ˜, ë¼ì¸)ì„ ëª…í™•íˆ ì•ˆë‚´í•˜ì„¸ìš”.
       - íŒŒì¼ ê²½ë¡œëŠ” GitHub ë§í¬ í˜•íƒœë¡œ ì œê³µí•˜ì„¸ìš”.

       ë¶„ì„ ê²°ê³¼ë¥¼ `gh pr comment`ë¡œ PRì— ì½”ë©˜íŠ¸ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.

       ## ì‘ë‹µ í˜•ì‹
       ### ğŸ”´ E2E í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë¶„ì„

       **ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸**: [í…ŒìŠ¤íŠ¸ ì´ë¦„ê³¼ íŒŒì¼ ê²½ë¡œ]

       **ì—ëŸ¬ ìš”ì•½**: [ë¬´ì—‡ì´ ì‹¤íŒ¨í–ˆëŠ”ì§€]

       **ê´€ë ¨ ì½”ë“œ**:
       - [íŒŒì¼ëª…](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/íŒŒì¼ê²½ë¡œ#Lë¼ì¸ë²ˆí˜¸) - ê´€ë ¨ì„± ì„¤ëª…

       **ë””ë²„ê¹… ì‹œì‘ì **:
       - [íŒŒì¼ëª…](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/íŒŒì¼ê²½ë¡œ#Lë¼ì¸ë²ˆí˜¸) - í™•ì¸ ë°©ë²•

       ---
       *ğŸ¤– ì´ ë¶„ì„ì€ AIê°€ ìë™ ìƒì„±í•œ ì´ˆê¸° ì¡°ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤.*
       *âš ï¸ ìœ„ ë‚´ìš©ì€ ì¶”ì¸¡ì— ê¸°ë°˜í•˜ë¯€ë¡œ, ì‹¤ì œ ìˆ˜ì • ì „ ì§ì ‘ ê²€ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.*
      show_full_output: true
      claude_args: |
       --allowedTools "Read,Glob,Grep,Bash(gh pr comment:*)"

   - name: Fail if E2E tests failed
     if: steps.e2e.outcome == 'failure'
     run: exit 1
